<!DOCTYPE html>
<html lang="en">

<head>
  <title>
  Week-11 (Coding Period) 29th July - 4th August · rishab_m
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">


<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self'; img-src 'self'; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' https://www.google-analytics.com; prefetch-src 'self'; connect-src 'self' https://www.google-analytics.com;">




<meta name="author" content="Rishab Mudliar">
<meta name="description" content="This week Link to heading Worked on moving my module to CaseHPC Tried perfecting F-RCNN for detecting saints and their attributes in paintings. Regarding CaseHPC Link to heading One of the things I couldn&rsquo;t do in the first phase of this program was to use Case Western&rsquo;s HPC to train my models in general. So this week I decided to get my hands dirty and made my module work on one of the gpu nodes of Case HPC">
<meta name="keywords" content="blog,developer,personal">

<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Week-11 (Coding Period) 29th July - 4th August"/>
<meta name="twitter:description" content="This week Link to heading Worked on moving my module to CaseHPC Tried perfecting F-RCNN for detecting saints and their attributes in paintings. Regarding CaseHPC Link to heading One of the things I couldn&rsquo;t do in the first phase of this program was to use Case Western&rsquo;s HPC to train my models in general. So this week I decided to get my hands dirty and made my module work on one of the gpu nodes of Case HPC"/>

<meta property="og:title" content="Week-11 (Coding Period) 29th July - 4th August" />
<meta property="og:description" content="This week Link to heading Worked on moving my module to CaseHPC Tried perfecting F-RCNN for detecting saints and their attributes in paintings. Regarding CaseHPC Link to heading One of the things I couldn&rsquo;t do in the first phase of this program was to use Case Western&rsquo;s HPC to train my models in general. So this week I decided to get my hands dirty and made my module work on one of the gpu nodes of Case HPC" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lazycodes7.github.io/posts/week11/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-04T23:56:36+05:30" />
<meta property="article:modified_time" content="2022-08-04T23:56:36+05:30" />





<link rel="canonical" href="https://lazycodes7.github.io/posts/week11/">


<link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.min.e1bdf152d93b060b06ba5d496486ed9c201a8b95d335e035beb5faebe3b61cad.css" integrity="sha256-4b3xUtk7BgsGul1JZIbtnCAai5XTNeA1vrX66&#43;O2HK0=" crossorigin="anonymous" media="screen" />






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css" integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin="anonymous" media="screen" />
  



 




<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/rm.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      rishab_m
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/about/">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/blogs/">Blogs</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/posts/">GSoC</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/projects/">Projects</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="https://lazycodes7.github.io/posts/week11/">
              Week-11 (Coding Period) 29th July - 4th August
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              <time datetime="2022-08-04T23:56:36&#43;05:30">
                August 4, 2022
              </time>
            </span>
            <span class="reading-time">
              <i class="fa fa-clock-o" aria-hidden="true"></i>
              6-minute read
            </span>
          </div>
          <div class="authors">
  <i class="fa fa-user" aria-hidden="true"></i>
    <a href="/authors/rishab-mudliar/">Rishab Mudliar</a></div>

          <div class="categories">
  <i class="fa fa-folder" aria-hidden="true"></i>
    <a href="/categories/google-summer-of-code/">Google Summer of Code</a></div>

          
        </div>
      </header>

      <div class="post-content">
        
        <h1 id="this-week">
  This week
  <a class="heading-link" href="#this-week">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<ul>
<li>Worked on moving my module to CaseHPC</li>
<li>Tried perfecting F-RCNN for detecting saints and their attributes in paintings.</li>
</ul>
<h2 id="regarding-casehpc">
  Regarding CaseHPC
  <a class="heading-link" href="#regarding-casehpc">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>One of the things I couldn&rsquo;t do in the first phase of this program was to use Case Western&rsquo;s HPC to train my models in general. So this week I decided to get my hands dirty and made my module work on one of the gpu nodes of Case HPC</p>
<h3 id="how-do-we-do-this">
  How do we do this?
  <a class="heading-link" href="#how-do-we-do-this">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>After circulating back and forth through Techne and Case HPC&rsquo;s documentation. I understood how to run my module on GPU. In order to make this easier for other participants in the future. I will explain the procedure for this in this blog.</p>
<h4 id="1-creating-singularity-containers">
  1. Creating Singularity Containers.
  <a class="heading-link" href="#1-creating-singularity-containers">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>This is sort of the main ingredient if you don&rsquo;t have this then you can&rsquo;t access those gpu nodes essentially.</p>
<h5 id="but-why-use-containers">
  But why use containers?
  <a class="heading-link" href="#but-why-use-containers">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h5>
<p>This is an interesting question right. I think the answer is to solve &lsquo;it works on my computer though&rsquo; problem. With this you import your whole environment such that it can work anywhere. For instance run <code>python --version</code> once you login to Case HPC. (Spoiler Alert: It is 2.7)</p>
<p>Now we can&rsquo;t run all those pytorch/tensorflow models in 2.7 right. This is where containers come in.</p>
<h5 id="how-to-create-one">
  How to create one?
  <a class="heading-link" href="#how-to-create-one">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h5>
<p>Now I am creating my containers from docker and then converting them to singularity so my solution will be exclusively based on that.</p>
<h6 id="1-create-a-dockerfile">
  1. Create a Dockerfile.
  <a class="heading-link" href="#1-create-a-dockerfile">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h6>
<p>Wherever your work is create a dockerfile which contains mostly things you might want in your container like python packages etc or some directories.</p>
<p>Here is an example.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>FROM python
</span></span><span style="display:flex;"><span>COPY YOLOv6 ./YOLOv6
</span></span><span style="display:flex;"><span>RUN apt-get update &amp;&amp; apt-get -y install gcc
</span></span><span style="display:flex;"><span>RUN apt-get -y install libgl1
</span></span><span style="display:flex;"><span>RUN pip install --upgrade pip setuptools wheel
</span></span><span style="display:flex;"><span>RUN pip3 install -r YOLOv6/requirements.txt
</span></span><span style="display:flex;"><span>WORKDIR <span style="font-style:italic">&#34;YOLOv6&#34;</span>
</span></span></code></pre></div><h6 id="2-next-build-the-docker-image">
  2. Next build the docker image.
  <a class="heading-link" href="#2-next-build-the-docker-image">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h6>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sudo docker build -t object-detector-yolov6 --progress=plain -f Dockerfile .
</span></span></code></pre></div><h6 id="3-pushing-to-docker-hub">
  3. Pushing to docker hub.
  <a class="heading-link" href="#3-pushing-to-docker-hub">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h6>
<p>If you haven&rsquo;t logged in first login using <code>docker login</code> then push the image using <code>docker push username/image-name</code></p>
<h6 id="4-next-convert-the-image-to-sif">
  4. Next convert the image to .sif
  <a class="heading-link" href="#4-next-convert-the-image-to-sif">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h6>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>singularity pull docker://username/image_name
</span></span></code></pre></div><p>That&rsquo;s it. Note that we can also do this locally as long as we have the docker image. But since I was working on Case HPC i decided to push it to docker hub so that I could pull it from that environment.</p>
<h4 id="2-using-gpu-nodes-on-casehpc">
  2. Using GPU nodes on CaseHPC
  <a class="heading-link" href="#2-using-gpu-nodes-on-casehpc">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>Assuming that the login steps have been (If not view how-to here) completed.</p>
<h5 id="1-go-to-the-gallina-home">
  1. Go to the gallina home
  <a class="heading-link" href="#1-go-to-the-gallina-home">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h5>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>cd \mnt\rds\redhen\gallina\home\abc123
</span></span></code></pre></div><h5 id="2-requesting-a-gpu-node">
  2. Requesting a GPU node.
  <a class="heading-link" href="#2-requesting-a-gpu-node">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h5>
<p>Case Western provides access to certain gpu nodes for processing. If you want to access one. Try running <code>si</code> first to see which ones are available</p>
<p>After that we use this command to finetune our requests for gpu. (Run srun help to learn more)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>srun -p gpu -C gpu2v100 --nodelist=gpu059t --gres=gpu:1 --mem=50gb --pty bash
</span></span></code></pre></div><p>Let&rsquo;s understand the params. If we ever want to access a node with gpu then it is important to include gpu param including the gpu we want using <code>si</code>. Next we can request a specific node again by checking which nodes are unallocated from the previous command. The memory param is basically for the amount of memory we want in our job and finally the bash lets us enter our gpu node is what I think. This is all I could understood after reading through the documentation and some powerpoints on Case HPC.</p>
<h5 id="2-syncing-files">
  2. Syncing files.
  <a class="heading-link" href="#2-syncing-files">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h5>
<p>After we gain access to this node. We now have to sync our files from gallina to here. For this we use rsync.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>rsync -az hpc3:/mnt/rds/redhen/gallina/home/rpm93/RedHenLab_Multimodal_Christian_Art_Tagging/ /tmp/$USER/
</span></span></code></pre></div><p>This step does it for us.</p>
<h5 id="3-using-the-gpu">
  3. Using the GPU
  <a class="heading-link" href="#3-using-the-gpu">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h5>
<p>Now that everything is done we just have to access the GPU. This is where singularity. Assuming that the singularity container has been pulled. We will see how to use it.
In order to run a container we normally require commands like <code>run</code> or <code>exec</code>. So I will show here how to run a python script in singularity</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>singularity run --nv art-detector-yolov6_latest.sif python tools/train.py --batch 32 --conf configs/yolov6s.py --data Iconart/data.yaml --device 0 --workers 0
</span></span></code></pre></div><p>Let&rsquo;s understand what happens here. The &ndash;nv is essentially to make sure that we can use GPU in the container and .sif is the image name. Finally we have the command we want to execute in the container.</p>
<p>Note: Singularity requires directories to be binded if we are running from another location that is not home. So just include &ndash;bind in that case.</p>
<h4 id="3-bonus-using-scripts">
  3. [Bonus] Using scripts
  <a class="heading-link" href="#3-bonus-using-scripts">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h4>
<p>We can always run commands one by one but why not do it all in one place when it is very easy to do so.</p>
<p>For instance this is the simple script I wrote for training my YOLOv6 model</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style=""></span>rsync -az hpc3:/mnt/rds/redhen/gallina/home/rpm93/RedHenLab_Multimodal_Christian_Art_Tagging/ /tmp/$USER/
</span></span><span style="display:flex;"><span>cd rpm93/modules/object-detection/YOLOv6
</span></span><span style="display:flex;"><span>module load singularity/3.8.1
</span></span><span style="display:flex;"><span>singularity pull docker://lazycodes7/art-detector-yolov6:latest
</span></span><span style="display:flex;"><span>singularity run --nv art-detector-yolov6_latest.sif python tools/train.py --batch 32 --conf configs/yolov6s.py --data Iconart/data.yaml --device 0 --workers 0
</span></span></code></pre></div><p>And I can run this by just doing <code>bash run_module.sh</code></p>
<p>This completes our YOLOv6 module. Of course we can make this script more interactive later but this is just an idea.</p>
<h2 id="using-f-rcnn">
  Using F-RCNN
  <a class="heading-link" href="#using-f-rcnn">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>During our final meeting before phase-1 ended. I had showcased my YOLOv6 model that worked fine to detect the saints in paintings. One of the problems with YOLOv6 is that it is a single-shot detector so while it is fast it might not be the most accurate and hence I wanted to try out Faster-RCNN again to see if I could do something with it to improve my performance.</p>
<h3 id="what-was-new-this-time">
  What was new this time
  <a class="heading-link" href="#what-was-new-this-time">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<p>One of the problems was that well-defined implementations of Faster-RCNN were scarce and so the model I built last time was bare-bones with no way to understand the metrics of the model&rsquo;s performance. Even the detector wasn&rsquo;t good enough for the problem I was solving. Since I had more time now, I decided to switch to Facebook Research&rsquo;s detectron2 that hosts implementation of various object-detection models.</p>
<p>Using detectron2, I converted my dataset to COCO format and then trained the model for 1500 iterations. I used the same labels as in YOLO. Here are some of the good results.</p>
<p><img src="/frcnn_outputs_old.jpg" alt=""></p>
<h1 id="next-week">
  Next Week
  <a class="heading-link" href="#next-week">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<ul>
<li>Read the book written by Emile Male recommended by Professor Mark Turner</li>
<li>Identifying more attributes related to the saints.</li>
</ul>

      </div>


      <footer>
        


        
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
      2019 -
    
    2024
     Rishab Mudliar 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js" integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>

</html>
